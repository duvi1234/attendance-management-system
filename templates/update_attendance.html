{% extends "base.html" %}

{% block content %}
<h2>Update Weekly Attendance</h2>

{% if active_semester %}
<div class="status-indicator status-active">
    <h3>Active Semester: {{ active_semester.name }}</h3>
    <p>You can only update attendance for subjects in the active semester.</p>
</div>

<form method="POST" action="{{ url_for('attendance.update_attendance') }}" id="attendance-form">
    <div class="dashboard-controls">
        <div class="form-group">
            <label for="week_date">Select a date in the week:</label>
            <input type="date" name="week_date" id="week_date" required>
        </div>
        <div class="form-group">
            <label for="subject">Subject:</label>
            <select name="subject" id="subject" required>
                <option value="">Select Subject</option>
                {% for subject in subjects %}
                <option value="{{ subject.id }}">{{ subject.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group" style="display: flex; align-items: center; gap: 8px;">
            <input type="checkbox" id="include_saturday" name="include_saturday">
            <label for="include_saturday" style="margin: 0;">Include Saturday</label>
        </div>
    </div>

    <div id="week-range-row" style="font-weight: 600; text-align: center; margin-bottom: 10px; display: none;">
        Week: <span id="week-range"></span>
    </div>
    <div id="week-days-section" style="margin-bottom: 20px; display: none;">
        <div class="table-container attendance-table" tabindex="0">
            <table>
                <tbody id="attendance-table-body">
                    <!-- Rows will be generated by JS -->
                </tbody>
            </table>
        </div>
    </div>

    <div style="margin-top: 20px; text-align: center;">
        <button type="submit">Submit Attendance</button>
    </div>
</form>

<div style="margin-top: 15px; padding: 10px; background-color: #e8f5e8; border-radius: 5px; font-size: 14px;">
    <strong>üí° Tips:</strong><br>
    ‚Ä¢ Enter total classes for the week once - it will be copied to all students.<br>
    ‚Ä¢ Pick any date in the week to auto-select Monday to Friday.<br>
    ‚Ä¢ Use the "Include Saturday" option if you have classes on Saturday.<br>
    ‚Ä¢ Enter attended classes for each student individually.<br>
</div>

<!-- Pass student data to JavaScript -->
<script id="students-data" type="application/json">
{{ students | tojson }}
</script>

<!-- Pass existing attendance data to JavaScript -->
<script id="existing-attendance-data" type="application/json">
{{ existing_attendance | tojson }}
</script>

<!-- Pass selected parameters to JavaScript -->
<script id="selected-subject-id" type="application/json">
{{ selected_subject_id | tojson }}
</script>

<script id="selected-week-date" type="application/json">
{{ selected_week_date | tojson }}
</script>

<script id="include-saturday-data" type="application/json">
{{ request.args.get('include_saturday') == 'true' | tojson }}
</script>
<script src="{{ url_for('static', filename='script.js') }}"></script>
<script>
const students = JSON.parse(document.getElementById('students-data').textContent);

function getMonday(date) {
    const d = new Date(date);
    const day = d.getDay();
    const diff = d.getDate() - day + (day === 0 ? -6 : 1); // adjust when day is Sunday
    return new Date(d.setDate(diff));
}

function formatDate(date) {
    return date.toISOString().split('T')[0];
}

function getWeekDates(monday, includeSaturday) {
    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
    if (includeSaturday) days.push('Saturday');
    return days.map((day, i) => {
        const date = new Date(monday);
        date.setDate(monday.getDate() + i);
        return { day, date: formatDate(date) };
    });
}

function updateWeekRange(monday, weekDates) {
    const mondayDate = weekDates[0].date;
    const lastDate = weekDates[weekDates.length - 1].date;
    const dayName = weekDates[weekDates.length - 1].day;
    document.getElementById('week-range').textContent = `${mondayDate} to ${lastDate} (${dayName})`;
    document.getElementById('week-range-row').style.display = '';
}



function renderAttendanceTable(weekDates) {
    const tbody = document.getElementById('attendance-table-body');
    tbody.innerHTML = '';
    
    // Create header row with simple columns
    const headerRow = document.createElement('tr');
    headerRow.innerHTML = `
        <th>Roll No</th>
        <th>Registration No</th>
        <th>Name</th>
        <th>Total Classes (Week)</th>
        <th>Attended Classes (Week)</th>
        <th>Percentage</th>
    `;
    tbody.appendChild(headerRow);
    
    // Create one row per student
    students.forEach((student, studentIdx) => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${student.roll_no}</td>
            <td>${student.reg_no}</td>
            <td>${student.name}</td>
            <td>
                <input type="number" name="total_${student.id}" min="0" 
                       class="attendance-input total-input" 
                       data-student-id="${student.id}" 
                       data-row="${studentIdx}" placeholder="Total" required>
            </td>
            <td>
                <input type="number" name="attended_${student.id}" min="0" 
                       class="attendance-input attended-input" 
                       data-student-id="${student.id}" 
                       data-row="${studentIdx}" placeholder="Attended" required>
            </td>
            <td>
                <span class="percent-preview" id="percent_preview_${student.id}"></span>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    // Load existing attendance data if available
    loadExistingAttendanceData();
}

// Load existing attendance data
function loadExistingAttendanceData() {
    try {
        const existingAttendance = JSON.parse(document.getElementById('existing-attendance-data').textContent);
        const selectedSubjectId = JSON.parse(document.getElementById('selected-subject-id').textContent);
        const selectedWeekDate = JSON.parse(document.getElementById('selected-week-date').textContent);
        
        if (existingAttendance && Object.keys(existingAttendance).length > 0) {
            Object.keys(existingAttendance).forEach(studentId => {
                const data = existingAttendance[studentId];
                const totalInput = document.querySelector(`input[name='total_${studentId}']`);
                const attendedInput = document.querySelector(`input[name='attended_${studentId}']`);
                const percentSpan = document.getElementById(`percent_preview_${studentId}`);
                
                if (totalInput && attendedInput) {
                    totalInput.value = data.total_classes;
                    attendedInput.value = data.total_attended;
                    if (percentSpan) {
                        percentSpan.textContent = data.percentage + '%';
                    }
                }
            });
        }
    } catch (error) {
        console.log('No existing attendance data to load');
    }
}

// Auto-copy total classes for all students
function setupAutoCopyTotal() {
    document.querySelectorAll('.total-input').forEach(input => {
        input.addEventListener('input', function(e) {
            const value = this.value;
            // Auto-copy total classes for all students
            document.querySelectorAll('.total-input').forEach(inp => {
                if (inp !== this) inp.value = value;
            });
            // Update all percentage previews
            updateAllPercentPreviews();
        });
    });
}

// Update all percentage previews
function updateAllPercentPreviews() {
    document.querySelectorAll('.attended-input').forEach(input => {
        const studentId = input.getAttribute('data-student-id');
        const total = document.querySelector(`input[name='total_${studentId}']`).value;
        const attended = input.value;
        const percentSpan = document.getElementById(`percent_preview_${studentId}`);
        
        if (total && attended && Number(total) > 0) {
            const percent = Math.round((Number(attended) / Number(total)) * 100);
            percentSpan.textContent = percent + '%';
        } else {
            percentSpan.textContent = '';
        }
    });
}

// Live percentage preview
function setupPercentPreview() {
    document.querySelectorAll('.attendance-input').forEach(input => {
        input.addEventListener('input', function() {
            const studentId = this.getAttribute('data-student-id');
            const total = document.querySelector(`input[name='total_${studentId}']`).value;
            const attended = document.querySelector(`input[name='attended_${studentId}']`).value;
            const percentSpan = document.getElementById(`percent_preview_${studentId}`);
            if (total && attended && Number(total) > 0) {
                const percent = Math.round((Number(attended) / Number(total)) * 100);
                percentSpan.textContent = percent + '%';
            } else {
                percentSpan.textContent = '';
            }
        });
    });
}

// Arrow key navigation
function setupArrowNavigation() {
    const allInputs = Array.from(document.querySelectorAll('.attendance-input'));
    allInputs.forEach((input, idx) => {
        input.addEventListener('keydown', function(e) {
            let nextIdx = null;
            if (e.key === 'ArrowDown') nextIdx = idx + 2;
            if (e.key === 'ArrowUp') nextIdx = idx - 2;
            if (e.key === 'ArrowRight') nextIdx = idx + 1;
            if (e.key === 'ArrowLeft') nextIdx = idx - 1;
            if (nextIdx !== null && nextIdx >= 0 && nextIdx < allInputs.length) {
                allInputs[nextIdx].focus();
                e.preventDefault();
            }
        });
    });
}

function setInputsEnabled(enabled) {
    document.querySelectorAll('.attendance-input').forEach(input => {
        if (input.classList.contains('total-input')) {
            // Total inputs are always readonly, but we can disable them
            input.disabled = !enabled;
        } else {
            // Attended inputs can be enabled/disabled normally
            input.disabled = !enabled;
        }
    });
}

function clearAllInputsAndPreviews() {
    document.querySelectorAll('.attendance-input').forEach(input => {
        input.value = '';
    });
    document.querySelectorAll('.percent-preview').forEach(span => {
        span.textContent = '';
    });
}

// Subject dropdown logic
const subjectSelect = document.getElementById('subject');
subjectSelect.addEventListener('change', function() {
    if (this.value) {
        setInputsEnabled(true);
    } else {
        setInputsEnabled(false);
    }
    clearAllInputsAndPreviews();
});

// After rendering table, set up features and disable inputs if no subject
function afterTableRender() {
    setupAutoCopyTotal();
    setupPercentPreview();
    setupArrowNavigation();
    setInputsEnabled(!!subjectSelect.value);
    clearAllInputsAndPreviews();
}



document.getElementById('week_date').addEventListener('change', function() {
    const date = this.value;
    const includeSaturday = document.getElementById('include_saturday').checked;
    const subject = document.getElementById('subject').value;
    
    if (date && subject) {
        loadExistingAttendanceForWeek(date, subject, includeSaturday);
    } else if (date) {
        const monday = getMonday(date);
        const weekDates = getWeekDates(monday, includeSaturday);
        renderAttendanceTable(weekDates);
        updateWeekRange(monday, weekDates);
        document.getElementById('week-days-section').style.display = '';
        afterTableRender();
    } else {
        document.getElementById('week-days-section').style.display = 'none';
        document.getElementById('week-range-row').style.display = 'none';
    }
});

document.getElementById('include_saturday').addEventListener('change', function() {
    const date = document.getElementById('week_date').value;
    const subject = document.getElementById('subject').value;
    
    if (date) {
        const monday = getMonday(date);
        const weekDates = getWeekDates(monday, this.checked);
        renderAttendanceTable(weekDates);
        updateWeekRange(monday, weekDates);
        document.getElementById('week-days-section').style.display = '';
        afterTableRender();
    }
});

// Add subject change listener
document.getElementById('subject').addEventListener('change', function() {
    const date = document.getElementById('week_date').value;
    const includeSaturday = document.getElementById('include_saturday').checked;
    
    if (date && this.value) {
        // Show the table when both date and subject are selected
        const monday = getMonday(date);
        const weekDates = getWeekDates(monday, includeSaturday);
        renderAttendanceTable(weekDates);
        updateWeekRange(monday, weekDates);
        document.getElementById('week-days-section').style.display = '';
        afterTableRender();
    }
});

// Function to load existing attendance data for a week
function loadExistingAttendanceForWeek(date, subjectId, includeSaturday) {
    const includeSaturdayParam = includeSaturday ? 'true' : 'false';
    const url = `${window.location.pathname}?week_date=${date}&subject_id=${subjectId}&include_saturday=${includeSaturdayParam}`;
    window.location.href = url;
}



// Pre-populate form fields on page load
document.addEventListener('DOMContentLoaded', function() {
    try {
        const selectedSubjectId = JSON.parse(document.getElementById('selected-subject-id').textContent);
        const selectedWeekDate = JSON.parse(document.getElementById('selected-week-date').textContent);
        const includeSaturday = JSON.parse(document.getElementById('include-saturday-data').textContent);
        
        if (selectedSubjectId) {
            document.getElementById('subject').value = selectedSubjectId;
        }
        if (selectedWeekDate) {
            document.getElementById('week_date').value = selectedWeekDate;
        }
        if (includeSaturday) {
            document.getElementById('include_saturday').checked = true;
        }
        
        // If both date and subject are selected, show the table
        if (selectedWeekDate && selectedSubjectId) {
            const monday = getMonday(selectedWeekDate);
            const weekDates = getWeekDates(monday, includeSaturday);
            renderAttendanceTable(weekDates);
            updateWeekRange(monday, weekDates);
            document.getElementById('week-days-section').style.display = '';
            afterTableRender();
        }
    } catch (error) {
        console.log('No pre-selected values to load');
    }
});
</script>

{% else %}
<div class="status-indicator status-warning">
    <h3>‚ö†Ô∏è No Active Semester</h3>
    <p>Please <a href="{{ url_for('attendance.manage_semesters') }}">create and activate a semester</a> first to update attendance.</p>
</div>
{% endif %}
{% endblock %}
