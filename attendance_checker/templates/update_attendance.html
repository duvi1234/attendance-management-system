{% extends "base.html" %}

{% block content %}
<h2>Update Weekly Attendance</h2>

{% if active_semester %}
<div class="status-indicator status-active">
    <h3>Active Semester: {{ active_semester.name }}</h3>
    <p>You can only update attendance for subjects in the active semester.</p>
</div>

<form method="POST" action="{{ url_for('attendance.update_attendance') }}" id="attendance-form">
    <div class="dashboard-controls">
        <div class="form-group">
            <label for="week_date">Select a date in the week:</label>
            <input type="date" name="week_date" id="week_date" required>
        </div>
        <div class="form-group">
            <label for="subject">Subject:</label>
            <select name="subject" id="subject" required>
                <option value="">Select Subject</option>
                {% for subject in subjects %}
                <option value="{{ subject.id }}">{{ subject.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group" style="display: flex; align-items: center; gap: 8px;">
            <input type="checkbox" id="include_saturday" name="include_saturday">
            <label for="include_saturday" style="margin: 0;">Include Saturday</label>
        </div>
    </div>

    <div id="week-range-row" style="font-weight: 600; text-align: center; margin-bottom: 10px; display: none;">
        Week: <span id="week-range"></span>
    </div>
    <div id="college-holiday-row" style="display:none; margin-bottom: 12px; text-align:center;"></div>
    <div id="week-days-section" style="margin-bottom: 20px; display: none;">
        <div class="table-container" tabindex="0">
            <table>
                <thead>
                    <tr>
                        <th>Roll No</th>
                        <th>Registration No</th>
                        <th>Name</th>
                        <th>Total Classes</th>
                        <th>Attended Classes</th>
                        <th>Preview %</th>
                    </tr>
                </thead>
                <tbody id="attendance-table-body">
                    <!-- Rows will be generated by JS -->
                </tbody>
            </table>
        </div>
    </div>

    <div style="margin-top: 20px; text-align: center;">
        <button type="submit">Submit Attendance</button>
    </div>
</form>

<div style="margin-top: 15px; padding: 10px; background-color: #e8f5e8; border-radius: 5px; font-size: 14px;">
    <strong>üí° Tips:</strong><br>
    ‚Ä¢ Pick any date in the week to auto-select Monday to Friday.<br>
    ‚Ä¢ Mark holidays to disable attendance input for that day.<br>
    ‚Ä¢ Use the "Include Saturday" option if you have classes on Saturday.<br>
</div>

<!-- Pass student data to JavaScript -->
<script id="students-data" type="application/json">
{{ students | tojson }}
</script>
<script src="{{ url_for('static', filename='script.js') }}"></script>
<script>
const students = JSON.parse(document.getElementById('students-data').textContent);

function getMonday(date) {
    const d = new Date(date);
    const day = d.getDay();
    const diff = d.getDate() - day + (day === 0 ? -6 : 1); // adjust when day is Sunday
    return new Date(d.setDate(diff));
}

function formatDate(date) {
    return date.toISOString().split('T')[0];
}

function getWeekDates(monday, includeSaturday) {
    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
    if (includeSaturday) days.push('Saturday');
    return days.map((day, i) => {
        const date = new Date(monday);
        date.setDate(monday.getDate() + i);
        return { day, date: formatDate(date) };
    });
}

function updateWeekRange(monday, weekDates) {
    const mondayDate = weekDates[0].date;
    const fridayDate = weekDates[4].date;
    document.getElementById('week-range').textContent = `${mondayDate} to ${fridayDate}`;
    document.getElementById('week-range-row').style.display = '';
}

function renderCollegeHolidayRow(weekDates) {
    const rowDiv = document.getElementById('college-holiday-row');
    rowDiv.innerHTML = weekDates.map(({day, date}) =>
        `<label style='margin:0 10px 0 0;display:inline-block;'><input type='checkbox' class='college-holiday-checkbox' data-day='${day}' id='college_holiday_${day}'> ${day} (${date})</label>`
    ).join('');
    rowDiv.style.display = '';
}

function renderAttendanceTable(weekDates) {
    const tbody = document.getElementById('attendance-table-body');
    tbody.innerHTML = '';
    weekDates.forEach(({day, date}) => {
        students.forEach((student, idx) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${student.roll_no}</td>
                <td>${student.reg_no}</td>
                <td>${student.name}</td>
                <td><input type="number" name="total_${student.id}_${day}" min="0" class="attendance-input total-input" data-student-id="${student.id}" data-day="${day}" data-row="${idx}" required></td>
                <td><input type="number" name="attended_${student.id}_${day}" min="0" class="attendance-input attended-input" data-student-id="${student.id}" data-day="${day}" data-row="${idx}" required></td>
                <td><span class="percent-preview" id="percent_preview_${student.id}_${day}"></span></td>
            `;
            tbody.appendChild(row);
        });
    });
}

// Auto-copy total classes for each day
function setupAutoCopyTotal() {
    document.querySelectorAll('.total-input').forEach(input => {
        input.addEventListener('input', function(e) {
            const day = this.getAttribute('data-day');
            const value = this.value;
            // Only auto-copy if this is the first student row for the day
            if (this.getAttribute('data-row') === '0') {
                document.querySelectorAll(`.total-input[data-day='${day}']`).forEach(inp => {
                    if (inp !== this) inp.value = value;
                });
            }
        });
    });
}

// Live percentage preview
function setupPercentPreview() {
    document.querySelectorAll('.attendance-input').forEach(input => {
        input.addEventListener('input', function() {
            const day = this.getAttribute('data-day');
            const studentId = this.getAttribute('data-student-id');
            const total = document.querySelector(`input[name='total_${studentId}_${day}']`).value;
            const attended = document.querySelector(`input[name='attended_${studentId}_${day}']`).value;
            const percentSpan = document.getElementById(`percent_preview_${studentId}_${day}`);
            if (total && attended && Number(total) > 0) {
                const percent = Math.round((Number(attended) / Number(total)) * 100);
                percentSpan.textContent = percent + '%';
            } else {
                percentSpan.textContent = '';
            }
        });
    });
}

// Arrow key navigation
function setupArrowNavigation() {
    const allInputs = Array.from(document.querySelectorAll('.attendance-input'));
    allInputs.forEach((input, idx) => {
        input.addEventListener('keydown', function(e) {
            let nextIdx = null;
            if (e.key === 'ArrowDown') nextIdx = idx + 2;
            if (e.key === 'ArrowUp') nextIdx = idx - 2;
            if (e.key === 'ArrowRight') nextIdx = idx + 1;
            if (e.key === 'ArrowLeft') nextIdx = idx - 1;
            if (nextIdx !== null && allInputs[nextIdx]) {
                allInputs[nextIdx].focus();
                e.preventDefault();
            }
        });
    });
}

function setInputsEnabled(enabled) {
    document.querySelectorAll('.attendance-input').forEach(input => {
        input.disabled = !enabled;
    });
}

function clearAllInputsAndPreviews() {
    document.querySelectorAll('.attendance-input').forEach(input => {
        input.value = '';
    });
    document.querySelectorAll('.percent-preview').forEach(span => {
        span.textContent = '';
    });
}

// Subject dropdown logic
const subjectSelect = document.getElementById('subject');
subjectSelect.addEventListener('change', function() {
    if (this.value) {
        setInputsEnabled(true);
    } else {
        setInputsEnabled(false);
    }
    clearAllInputsAndPreviews();
});

// After rendering table, set up features and disable inputs if no subject
function afterTableRender() {
    setupAutoCopyTotal();
    setupPercentPreview();
    setupArrowNavigation();
    setInputsEnabled(!!subjectSelect.value);
    clearAllInputsAndPreviews();
}

function setHolidayForDay(day, isHoliday) {
    document.querySelectorAll(`input[data-day='${day}']`).forEach(input => {
        if (input.type === 'number') {
            input.value = '';
            input.disabled = isHoliday;
        }
    });
}

document.getElementById('week_date').addEventListener('change', function() {
    const date = this.value;
    const includeSaturday = document.getElementById('include_saturday').checked;
    if (date) {
        const monday = getMonday(date);
        const weekDates = getWeekDates(monday, includeSaturday);
        renderCollegeHolidayRow(weekDates);
        renderAttendanceTable(weekDates);
        updateWeekRange(monday, weekDates);
        document.getElementById('week-days-section').style.display = '';
        setTimeout(() => {
            weekDates.forEach(({day}) => {
                const checkbox = document.getElementById(`college_holiday_${day}`);
                if (checkbox) {
                    checkbox.addEventListener('change', function() {
                        setHolidayForDay(day, this.checked);
                    });
                }
            });
            afterTableRender();
        }, 0);
    } else {
        document.getElementById('week-days-section').style.display = 'none';
        document.getElementById('week-range-row').style.display = 'none';
        document.getElementById('college-holiday-row').style.display = 'none';
    }
});
document.getElementById('include_saturday').addEventListener('change', function() {
    const date = document.getElementById('week_date').value;
    if (date) {
        const monday = getMonday(date);
        const weekDates = getWeekDates(monday, this.checked);
        renderCollegeHolidayRow(weekDates);
        renderAttendanceTable(weekDates);
        updateWeekRange(monday, weekDates);
        document.getElementById('week-days-section').style.display = '';
        setTimeout(() => {
            weekDates.forEach(({day}) => {
                const checkbox = document.getElementById(`college_holiday_${day}`);
                if (checkbox) {
                    checkbox.addEventListener('change', function() {
                        setHolidayForDay(day, this.checked);
                    });
                }
            });
            afterTableRender();
        }, 0);
    }
});
</script>

{% else %}
<div class="status-indicator status-warning">
    <h3>‚ö†Ô∏è No Active Semester</h3>
    <p>Please <a href="{{ url_for('attendance.manage_semesters') }}">create and activate a semester</a> first to update attendance.</p>
</div>
{% endif %}
{% endblock %}
